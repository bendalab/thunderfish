{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"ThunderFish Algorithms and programs for analysing electric field recordings of weakly electric fish. Weakly electric fish generate an electric organ discharge (EOD). In wave-type fish the EOD resembles a sinewave of a specific frequency and with higher harmonics. In pulse-type fish EODs have a distinct waveform and are separated in time. The thunderfish package provides algorithms and tools for analysing both wavefish and pulsefish EODs. Installation ThunderFish is available from PyPi . Simply run: pip install thunderfish This should also install: - ThunderLab - AudioIO Software The thunderfish package provides the following software: thunderfish : Detect, analyze, and plot all EOD waveforms in short recordings. Simply run ```sh thunderfish data/Apteronotus-Fishfinder-Panama-RioCanita-2014-05-17-L13.wav ``` To produce the image shown above. Read more collectfish : Collect data generated by thunderfish . eodexplorer : View and explore properties of EOD waveforms. thunderlogger : Extract EOD waveforms from logger recordings. Various viewers They will eventually be replaced by some plugins for audian . fishfinder : Browse EOD recordings and detect EOD frequencyies on the fly. thunderbrowse : Browse multi-channel EOD recordings. Data In data/ you find a view recordings on which you can run thunderfish software. You find more fishfinder recordings for rigorous testing in the pulseeods repository that has been assembled by Liz Weerdmeester. Algorithms The following modules provide the algorithms for analyzing EOD recordings. Look into the modules for more information. Input/output hopkinsloader : Load EODs from Hopkins files. EOD analysis bestwindow : Select the region within a recording with the most stable signal of largest amplitude that is not clipped. checkpulse : Check whether a pulse-type or a wave-type weakly electric fish is present in a recording. consistentfishes : Create a list of EOD frequencies with fishes present in all provided fish lists. eodanalysis : Analyse EOD waveforms. harmonics : Extract and analyze harmonic frequencies from power spectra. pulses : Extract and cluster EOD waverforms of pulse-type electric fish. EOD simulations fakefish : Simulate EOD waveforms. efield : Simulations of spatial electric fields. fishshapes : Manipulate and plot fish outlines.","title":"Home"},{"location":"#thunderfish","text":"Algorithms and programs for analysing electric field recordings of weakly electric fish. Weakly electric fish generate an electric organ discharge (EOD). In wave-type fish the EOD resembles a sinewave of a specific frequency and with higher harmonics. In pulse-type fish EODs have a distinct waveform and are separated in time. The thunderfish package provides algorithms and tools for analysing both wavefish and pulsefish EODs.","title":"ThunderFish"},{"location":"#installation","text":"ThunderFish is available from PyPi . Simply run: pip install thunderfish This should also install: - ThunderLab - AudioIO","title":"Installation"},{"location":"#software","text":"The thunderfish package provides the following software: thunderfish : Detect, analyze, and plot all EOD waveforms in short recordings. Simply run ```sh thunderfish data/Apteronotus-Fishfinder-Panama-RioCanita-2014-05-17-L13.wav ``` To produce the image shown above. Read more collectfish : Collect data generated by thunderfish . eodexplorer : View and explore properties of EOD waveforms. thunderlogger : Extract EOD waveforms from logger recordings.","title":"Software"},{"location":"#various-viewers","text":"They will eventually be replaced by some plugins for audian . fishfinder : Browse EOD recordings and detect EOD frequencyies on the fly. thunderbrowse : Browse multi-channel EOD recordings.","title":"Various viewers"},{"location":"#data","text":"In data/ you find a view recordings on which you can run thunderfish software. You find more fishfinder recordings for rigorous testing in the pulseeods repository that has been assembled by Liz Weerdmeester.","title":"Data"},{"location":"#algorithms","text":"The following modules provide the algorithms for analyzing EOD recordings. Look into the modules for more information.","title":"Algorithms"},{"location":"#inputoutput","text":"hopkinsloader : Load EODs from Hopkins files.","title":"Input/output"},{"location":"#eod-analysis","text":"bestwindow : Select the region within a recording with the most stable signal of largest amplitude that is not clipped. checkpulse : Check whether a pulse-type or a wave-type weakly electric fish is present in a recording. consistentfishes : Create a list of EOD frequencies with fishes present in all provided fish lists. eodanalysis : Analyse EOD waveforms. harmonics : Extract and analyze harmonic frequencies from power spectra. pulses : Extract and cluster EOD waverforms of pulse-type electric fish.","title":"EOD analysis"},{"location":"#eod-simulations","text":"fakefish : Simulate EOD waveforms. efield : Simulations of spatial electric fields. fishshapes : Manipulate and plot fish outlines.","title":"EOD simulations"},{"location":"collectfish/","text":"collectfish Collect data generated by thunderfish in a wavefish and a pulsefish table. Command line arguments collectfish --help returns usage: collectfish [-h] [--version] [-v] [-t {wave,pulse}] [-c] [-m N] [-p N:M] [-w N] [-r COLUMN] [-s] [-i FILE:REC:TEMP] [-q Q10] [-S] [-n NAME] [-o PATH] [-f {dat,ascii,csv,rtai,md,tex,html,same}] file [file ...] Collect data generated by thunderfish in a wavefish and a pulsefish table. positional arguments: file a *-wavefish.* or *-pulsefish.* file as generated by thunderfish optional arguments: -h, --help show this help message and exit --version show program's version number and exit -v verbosity level: -v for meta data coverage, -vv for additional info on discarded recordings. -t {wave,pulse} wave-type or pulse-type fish -c remove initial common directories from input files -m N maximum number of fish to be taken from each recording -p N:M add properties of peak N to M of pulse-type EODs to the table -w N add properties of first N harmonics of wave-type EODs to the table -r COLUMN columns to be removed from output table -s also write table with statistics -i FILE:REC:TEMP insert rows from metadata table in FILE matching recording in colum REC. The optional TEMP specifies a column with temperatures to which EOD frequencies should be adjusted -q Q10 Q10 value for adjusting EOD frequencies to a common temperature -S skip recordings that are not contained in metadata table -n NAME name for summary files that is appended to \"wavefish\" or \"pulsefish\" -o PATH path where to store summary tables -f {dat,ascii,csv,rtai,md,tex,html,same} file format used for saving summary tables (\"same\" uses same format as input files) version 1.9.3 by Benda-Lab (2019-2020)","title":"collectfish"},{"location":"collectfish/#collectfish","text":"Collect data generated by thunderfish in a wavefish and a pulsefish table.","title":"collectfish"},{"location":"collectfish/#command-line-arguments","text":"collectfish --help returns usage: collectfish [-h] [--version] [-v] [-t {wave,pulse}] [-c] [-m N] [-p N:M] [-w N] [-r COLUMN] [-s] [-i FILE:REC:TEMP] [-q Q10] [-S] [-n NAME] [-o PATH] [-f {dat,ascii,csv,rtai,md,tex,html,same}] file [file ...] Collect data generated by thunderfish in a wavefish and a pulsefish table. positional arguments: file a *-wavefish.* or *-pulsefish.* file as generated by thunderfish optional arguments: -h, --help show this help message and exit --version show program's version number and exit -v verbosity level: -v for meta data coverage, -vv for additional info on discarded recordings. -t {wave,pulse} wave-type or pulse-type fish -c remove initial common directories from input files -m N maximum number of fish to be taken from each recording -p N:M add properties of peak N to M of pulse-type EODs to the table -w N add properties of first N harmonics of wave-type EODs to the table -r COLUMN columns to be removed from output table -s also write table with statistics -i FILE:REC:TEMP insert rows from metadata table in FILE matching recording in colum REC. The optional TEMP specifies a column with temperatures to which EOD frequencies should be adjusted -q Q10 Q10 value for adjusting EOD frequencies to a common temperature -S skip recordings that are not contained in metadata table -n NAME name for summary files that is appended to \"wavefish\" or \"pulsefish\" -o PATH path where to store summary tables -f {dat,ascii,csv,rtai,md,tex,html,same} file format used for saving summary tables (\"same\" uses same format as input files) version 1.9.3 by Benda-Lab (2019-2020)","title":"Command line arguments"},{"location":"eodexplorer/","text":"eodexplorer View and explore properties of EOD waveforms. Command line arguments eodexplorer --help returns usage: eodexplorer [-h] [--version] [-v] [-l] [-j [JOBS]] [-D {all,allpower,noise,timing,ampl,relampl,power,relpower,phase,time,width,peaks,none}] [-d COLUMN] [-n MAX] [-w {first,second,ampl,power,phase}] [-s] [-c COLUMN] [-m CMAP] [-p PATH] [-P PATH] [-f {dat,ascii,csv,rtai,md,tex,html,same}] file View and explore properties of EOD waveforms. positional arguments: file a wavefish.* or pulsefish.* summary file as generated by collectfish optional arguments: -h, --help show this help message and exit --version show program's version number and exit -v verbose output -l list all available data columns and exit -j [JOBS] number of jobs run in parallel for loading waveform data. Without argument use all CPU cores. -D {all,allpower,noise,timing,ampl,relampl,power,relpower,phase,time,width,peaks,none} default selection of data columns, check them with the -l option -d COLUMN data columns to be appended or removed (if already listed) for analysis -n MAX maximum number of harmonics or peaks to be used -w {first,second,ampl,power,phase} add first or second derivative of EOD waveform, or relative amplitude, power, or phase to the plot of selected EODs. -s save PCA components and exit -c COLUMN data column to be used for color code or \"row\" -m CMAP name of color map -p PATH path to the analyzed EOD waveform data -P PATH path to the raw EOD recordings -f {dat,ascii,csv,rtai,md,tex,html,same} file format used for saving PCA data (\"same\" uses same format as input file) version 1.9.1 by Benda-Lab (2019-2020) mouse: left click select data points left and drag rectangular selection and zoom of data points shift + left click/drag add data points to selection ctrl + left click/drag remove data points from selection double left click run thunderfish on selected EOD waveform key shortcuts: l list selected EOD waveforms on console p,P toggle between data columns, PC, and scaled PC axis <, pageup decrease number of displayed data columns/PC axis >, pagedown increase number of displayed data columns/PC axis w toggle maximized waveform plot o, z toggle zoom mode on or off backspace zoom back ctrl + a select all +, - increase, decrease pick radius 0 reset pick radius n, N decrease, increase number of bins of histograms h toggle between scatter plot and 2D histogram c, C cycle color map trough data columns left, right, up, down show and move magnified scatter plot escape close magnified scatter plot","title":"eodexplorer"},{"location":"eodexplorer/#eodexplorer","text":"View and explore properties of EOD waveforms.","title":"eodexplorer"},{"location":"eodexplorer/#command-line-arguments","text":"eodexplorer --help returns usage: eodexplorer [-h] [--version] [-v] [-l] [-j [JOBS]] [-D {all,allpower,noise,timing,ampl,relampl,power,relpower,phase,time,width,peaks,none}] [-d COLUMN] [-n MAX] [-w {first,second,ampl,power,phase}] [-s] [-c COLUMN] [-m CMAP] [-p PATH] [-P PATH] [-f {dat,ascii,csv,rtai,md,tex,html,same}] file View and explore properties of EOD waveforms. positional arguments: file a wavefish.* or pulsefish.* summary file as generated by collectfish optional arguments: -h, --help show this help message and exit --version show program's version number and exit -v verbose output -l list all available data columns and exit -j [JOBS] number of jobs run in parallel for loading waveform data. Without argument use all CPU cores. -D {all,allpower,noise,timing,ampl,relampl,power,relpower,phase,time,width,peaks,none} default selection of data columns, check them with the -l option -d COLUMN data columns to be appended or removed (if already listed) for analysis -n MAX maximum number of harmonics or peaks to be used -w {first,second,ampl,power,phase} add first or second derivative of EOD waveform, or relative amplitude, power, or phase to the plot of selected EODs. -s save PCA components and exit -c COLUMN data column to be used for color code or \"row\" -m CMAP name of color map -p PATH path to the analyzed EOD waveform data -P PATH path to the raw EOD recordings -f {dat,ascii,csv,rtai,md,tex,html,same} file format used for saving PCA data (\"same\" uses same format as input file) version 1.9.1 by Benda-Lab (2019-2020) mouse: left click select data points left and drag rectangular selection and zoom of data points shift + left click/drag add data points to selection ctrl + left click/drag remove data points from selection double left click run thunderfish on selected EOD waveform key shortcuts: l list selected EOD waveforms on console p,P toggle between data columns, PC, and scaled PC axis <, pageup decrease number of displayed data columns/PC axis >, pagedown increase number of displayed data columns/PC axis w toggle maximized waveform plot o, z toggle zoom mode on or off backspace zoom back ctrl + a select all +, - increase, decrease pick radius 0 reset pick radius n, N decrease, increase number of bins of histograms h toggle between scatter plot and 2D histogram c, C cycle color map trough data columns left, right, up, down show and move magnified scatter plot escape close magnified scatter plot","title":"Command line arguments"},{"location":"pulses/","text":"Pulses The purpose of the algorithm is to automatically detect and classify pulse-type EODs. A recording is scanned for pulse-type EODs, which are then clustered based on their waveforms. For each pulse-type weakly electric fish present in a recording, a sufficient amount of EOD timepoints is extracted to compute a reliable estimate of their original EOD. Raw data The following figure shows some field recording snippets containing three pulse-type EODs, an artefact, and a wave-type EOD. It gives a quick overview on the variety in EOD waveforms, timescales and amplitudes. The pulses algorithm is designed to not only detect and classify pulse-type EODs, but also to discriminate between pulse and wave-type EODs, artefacts and noise. Principles The pulse-fish EOD classification algorithm consists of four main steps: Data preprocessing Pulse-type EOD peak detection EOD classification (clustering) Post-processing First of all, the analyzed recording data is interpolated to 500kHz. Secondly, a peak detection algorithm is run that is specifically designed to detect multi-phasic EOD pulses in noisy environments. EOD pulses are detected even when they are superimposed on slower signals, such as wave-type EODs, 50/60Hz noise and/or static noise. Then, properties of all pulse EODs in a recording are extracted and clustered. As EOD shapes are species and location dependent, their features can be used to cluster the waveforms and infer the average waveform of each fish present in the recording. Lastly, some post-processing steps are performed to ensure that each present pulse-type electric fish is only represented once, and to ensure that the extracted EOD timepoints are sufficient to estimate a reliable average EOD waveform. Data preprocessing As the clustering methods depend on EOD waveform similarities, they should be of high enough resolution to properly align and compare waveforms. To ensure this, the recording data is quadratically interpolated to 500 kHz, which should be high enough to show smooth EOD pulses even for Mormyrids. Pulse-type EOD peak detection The peak detection algorithm consists of four steps: Detect all peaks and troughs. Create peak-trough pairs. Delete peak-trough pairs with unrealistic widths ( w < 2/F s or w> 30ms ). Delete overlapping peak-trough pairs. Peaks and troughs are detected by an algorithm for identifying peaks in physiological signals (Bryan S. Todd and David C. Andrews (1999)). The threshold for this peak detection is determined by the median of the standard deviation of the recording data. The standard deviation is taken on 1000 windows of 0.5ms in size, uniformly distributed over the recording data. Choosing said window size enables the detection of pulse-type EODs peaks that are superimposed on wave-type waveforms of up to 2000Hz. Peak-trough pairs are created by connecting each peak to a neighboring trough either on the right- or on the left-hand side of the peak. To determine which trough to connect to, for both peak-trough pair options, the amplitude difference and the amplitude difference divided by the temporal difference i.e. amplitude differential are computed. If the amplitude differential is similar for both sides (<=25%), the peak-trough pair which results in the highest amplitude difference is chosen. If the amplitude differential is too variable (>25%), the peak-trough pair which results in the highest amplitude differential is chosen. Said mechanism enables correct peak detection of narrow EODs that are superimposed on low frequency waves, even when these background waves are higher in amplitude. Unrealistic peak-trough pair widths are either those that characterize noise and/or artefacts, e.g. widths that are close to the sampling frequency of the recording device, or those that are biologically not feasible due to their unrealistic temporal scale e.g. >30ms. As peak-trough pairs with said widths are likely not part of pulse-type EODs, they are discarded. Due to the nature of the peak-trough pair selection mechanism, it is possible that two peaks are connected to the same trough. As the clustering step is performed on features extracted based on both the peak and the trough of each peak-trough pair, overlap in these features is not desirable. Therefore, for all troughs that connect to two peaks, one of the peak-trough pairs is discarded. The mechanism for choosing the peak-trough pair that is to be kept is the same as the one used in step 2. Now that for each pulse-type EOD at least one peak-trough pair is made, the first features can be extracted. Extracted features are width, which is the temporal difference for each peak-trough pair, and height, which is the amplitude difference for each peak-trough pair. EOD classification (clustering) The clustering algorithm is composed of five steps. First of all, a Gaussian clustering method is used to create clusters based on EOD width. Secondly, within each width cluster, another Gaussian clustering step is performed on EOD heights. Then, within these clusters, a third clustering step is performed on the principle components of the EOD waveforms centered on the peak and on the EOD waveforms centered on the trough. For this, the DBSCAN clustering algorithm is used. The fourth step of the clustering algorithm uses the mean features of each cluster to determine which clusters are pulse EODs, and discards all wave-type EODs and artefacts. Lastly, the resulting clusters from peak-centered EOD waveforms are merged with the resulting clusters from trough-centered waveforms. Width EOD width is the only feature that remains stable for individual fish, even when they are moving with respect to the recording electrode, and is therefore assumed to be Gaussian distributed for individual fish. A Bayesian Gaussian Mixture model (BGM) is applied to all EOD widths, where a mixture of three Gaussians is fit to the distribution. BGM models are suitable when the number of clusters is unknown, as some of the Gaussian fit weights can be set to zero. Therefore, three is merely the maximum number of clusters, where cases with less underlying EOD width distributions should result in less EOD width clusters. A maximum of three width clusters is expected, as EOD width is species dependent, and even though more than three pulsetype fish could be present in one recording, the maximum number of pulse-type fish species found in one wild recording is expected not to exceed three. To prevent faulty EOD width clustering due to sparse data, an extra check is performed, where clusters with a median width similarity of over 50% are merged. Feature extraction Not only is the EOD peak-trough width a useful feature for classifying EODs, it is also proportional to the entire EOD width, of which an estimate is desired to extract EOD waveforms. Therefore, after the first clustering step, EOD snippets are extracted around all EOD peaks and troughs for each width cluster, where the total snippet widths are proportional to the median peak-trough width of the EODs in that cluster (3w\u0303). In some recordings, EOD pulses are sparse and have a very good Signal to Noise Ratio ( SNR ). In this case, it is desirable to be strict in the following clustering steps, as in these conditions, it would be possible to separate EODs that are very similar in shape. If the SNR is low, e.g. due to low quality recording devices, pulsefish that are far away from the recording device, 60Hz noise, wavefish EODs and/or an abundance of electric fish in general, setting clustering thresholds that are too strict might result either in single pulsefish that are classified in multiple EOD clusters or in pulsefish that are not clustered at all. Therefore, SNR is computed for each EOD snippet, by dividing the EOD height by the background activity amplitude. The background activity amplitude is here defined as the absolute amplitude difference between the first and the last instance of each EOD snippet. Height Now that all EOD snippets are extracted, one could cluster the EODs by their shape and height. However, automating cluster parameters at this point is tricky. As all EOD snippets contain multiple datapoints, the cluster space becomes multi-dimensional. Computing another BGM model in this space is possible and would be suitable as this method handles variable cluster densities well, due to the sigma fit that can be different for each Gaussian. To actually perform this clustering method on multi-dimensional data, on the other hand, a lot of computing time is needed as increasing dimensionality increases the search space for the model. The model could easily be stuck in local optima and would need to be run multiple times to obtain reliable results. Another drawback of using a BGM for this clustering step is that it does not account for noise and will either create a new cluster for noisy snippets or, even worse, include noise within the actual pulse EOD clusters. Consequently, regarding EOD shape, a distance-based clustering method is desired. DBSCAN is such a clustering method, which also performs well in discarding noise. For the DBSCAN method, two parameters are needed, of which one is the minimum distance between two points in cluster space for them to be identified as neighboring points. As this parameter is fixed for all clusters, all clusters should have similar densities. When taking the absolute distance between EOD snippets however, EODs with higher amplitudes will have be more distant in cluster space than EODs with lower amplitudes. This results in varying cluster densities, which complicates automating DBSCAN clustering. One could solve this issue by normalizing all EOD snippets. This again causes two problems. First of all, low amplitude EODs will show lower SNR s. If these EODs are normalized, the noise within these snippets scales linearly with the snippet. Cluster densities will now be variable not due to amplitude differences but due to SNR differences. Secondly, and most importantly, the EOD height is completely ignored when clustering, even though this contains valuable information on the pulsefish position. These issues are solved by computing two cascading clustering steps: one clustering step on height, which is a one-dimentional feature on which a BGM can be computed, and one further clustering step on EOD shape where DBSCAN is used. The relation between electrical source distance to the recording electrode and recorded EOD amplitude is negative and non-linear. In an oversimplified way, the electric field over distance is proportional to 1/r 3 , where r signifies the distance to the electric source. For stationary fish, the recorded EOD amplitude should be stable and somewhat Gaussian. Because of the non-linear relation between distance and EOD amplitude, fish that are closer to the recording electrode will have more variable EOD amplitudes than fish that are further away from the recording electrode. To account for this variance bias, clustering is done on the logarithm of the EOD amplitudes. A BGM model is used to cluster on the logarithm of the EOD heights, where a mixture of ten Gaussians is fit to the distribution. Then, all EOD height clusters with a median height similarity of 10% are merged. If 1/SNR is higher than 10%, the background noise could have influenced the EOD height distribution resulting in a higher EOD amplitude variance. To avoid splitting such clusters in half, additionally, all clusters with a median height similarity of 1/SNR are merged. Shape There are two sets of EOD snippets, one that is EOD peak centered and one that is EOD trough centered. Depending on the relative orientation between pulsefish and electrode, EOD pulse activity could be centered either around the most significant EOD peak or trough, or around the midpoint of the most significant EOD peak and trough. Either of the snippet sets could convey most information on the EOD shape and result in the most reliable EOD clusters, thus clustering is performed on both snippets sets. The resulting clusters are merged later on. Clustering on EOD shape is done by using DBSCAN . As explained earlier, uniform cluster densities are desired and therefore, some normalization step is required. After normalizing the EOD snippets, the first five principle components are computed and used as features for clustering. This dimensionality reduction results in an improved computing time, standardizes the DBSCAN input dimensionality, and makes sure that only the most important features of the EODs are considered for clustering. Normalization and feature extraction The first normalization step gets rid of any background activity. If the EOD is superimposed on any type of slower waveform, this background activity can be approximated by a straight line. For each EOD snippet, a linear interpolation is made between the first and the last snippet instance and subtracted from the snippet. Secondly, any DC component is deleted, by subtracting the mean of the EOD. Lastly, all EOD snippets are multiplied by a factor so that their absolute integral equals one. This last step is useful as sets of EOD snippets can have different widths. Wider EOD snippets naturally have a higher distance in cluster space due to the increase in datapoints. The absolute integral is thus secured to standardize the cluster densities and therefore clustering parameters. Lastly, PCA is done on all snippets, and the first five PCs are used for clustering. DBSCAN parameters DBSCAN is a nearest-neighbor based clustering method that requires two parameters: epsilon and minp . minp is the minimum amount of points that is needed to form a cluster, and epsilon is a value that determines the maximum distance between two points for them to be neighbors. Both parameters are automatically set based on the data properties. minp is set to be equal to 1% of the total number of datapoints in cluster space. If this number is less than 10, minp is set to 10, as with the current thunderfish settings, the length of the analysis window is 8 seconds. As all pulse-type electric fish species generally have EOD rates above 2 Hz, a minimum cluster size of 10 is deemed sufficient. epsilon is set based on the 80 th percentile of the K-Nearest Neighbor distribution, where K is minp . This measure ensures that 80% of the datapoints in cluster space are connected to at least minp datapoints. With said method, clusters would be formed even for datapoints with great dissimilarities. To prevent epsilon from growing too large, an upper bound is set. Generally, the maximum value for epsilon ( eps_max ) would only allow for a certain variance within clusters. As all EOD snippets have their absolute integral set to 1, setting eps_max to 0.1 would result in EOD clusters with a maximum variance of 10%. However, for EODs with a low SNR , more EOD variance is expected. Therefore, if 1/SNR is over 0.25, eps_max = 0.4/SNR . Selecting pulse-type EOD clusters Now that all clusters are formed, all clusters that are composed of artefacts, noise, wavefish and/or wrongly centered pulse-type EODs should be deleted. To separate the desired pulse-type EOD clusters from the undesirable clusters, three measures are used. The first measure is based on the discrete Fast Fourier Transform (FFT) of the normalized average cluster waveform. Artefacts and noise are expected to have more activity in high frequency ranges, and EOD waveforms are expected to have more activity in low frequency ranges. As the FFT is limited by the Nyquist frequency ( f_Nyq ) of the recording data, and as the sampling rate is often chosen so that pulse-type EODs are slower than the Nyquist frequency, the measure that is used for determining the ratio of low frequency activity in an EOD snippet is the integral of the entire FFT divided by the integral of the mean EOD FFT up to f_Nyq/2 . All EOD clusters with low frequency ratios below 75% are discarded. The second measure is based on the ratio between EOD peak to trough widths and the distances between two consecutive EODs (ISI). Pulse-type electric fish are characterized by their relatively narrow pulses and broad ISIs while wave-type fish have pulses and ISIs that are in the same order of magnitude. Therefore, any clusters that have at least one EOD peak-trough width to ISI ratio above 0.5 are discarded. The last measure is based on the peaks and troughs found in a zoomed out version (snippet width = 8w\u0303) of the average cluster EOD, where the peaks and troughs are computed by the method of Bryan S. Todd and David C. Andrews (1999) and the threshold is set to the standard deviation of the snippet. First of all, it can be determined whether the EOD cluster is based on a wrongly centered EOD pulse, as the maximum peak-trough distance of the average cluster EOD should be centered. If this is not the case, the cluster can be deleted. Furthermore, it can be the case that an EOD cluster is composed of wavefish snippets, but was not discarded earlier, as the EODs are only sparsely detected, and therefore result in low EOD peak-trough width to ISI ratios. To account for such cases, EOD clusters are discarded if the number of peaks and troughs detected in the average zoomed out EOD exceeds four. An extra check is performed on this zoomed out average EOD by computing the difference between the width of the most significant peak-trough in the average EOD and in the original EODs. If this difference is over 50%, it indicates that even if there are some pulse-type EODs in this cluster, they are not preserved in the mean EOD and are therefore discarded. Merge clusters As clustering was done on peak-centered snippets and on trough-centered EOD snippets, most pulse-type EOD clusters are represented at least twice. In some cases, the snippets that are centered either on the EOD peaks or EOD troughs are slightly misaligned, resulting in the formation of two clusters for one fish. This misalignment only happens on EOD peaks or troughs that are not in the center of the EOD pulse, as this is a more variable area than the EOD center. Due to centering the snippets on the most significant EOD peak and through, either one of the snippets should be best aligned and result in the best EOD clustering. Merging clusters is therefore done in several steps, where in each step, the largest cluster is saved. Below is some pseudo-code that describes the cluster merging algorithm. Here, A is the set of clusters for the peak-centered EODs and B is the set of clusters for the trough-centered EODs. As all detected peaks and troughs are present in pairs, each datapoint in A has one mapping to a datapoint in B . while clusters in A and B: select cluster C with largest N if C in A: delete clusters in B with at least one connection to C save cluster C and delete from A if C in B: delete clusters in A with at least one connection to C save cluster C and delete from B Post-processing Lastly, two post-processing steps are performed to account for moving fish and sparse EOD clusters. Moving fish Due to their dipole electric fields, electric fish that move with respect to the recording electrode display varying EOD shapes and amplitudes, which in turn leads to a single fish that is represented in multiple EOD clusters. The only factor that remains stable for moving pulsefish is their EOD pulsewidth. To ensure that each fish is only represented once, the following method is used. As EOD widths are not changing for moving fish, EODs in different width clusters are treated separately, as they cannot possibly come from the same fish. To estimate the actual number of fish in a recording for each width cluster, a sliding window is used. The sliding window is slid over all timepoints in the recording and counts the number of EOD clusters in a width cluster. The minimum number of EOD clusters that are counted within any of these windows should give a lower bound on the actual number of fish present in a recording. The stepsize of the sliding window is 0.1s. The width of this sliding window is either 0.25s, or, if the mean EOD peak-trough width is larger than 0.125ms, a factor of the mean EOD peak-trough width (2000w\u0303) of the width cluster. Sliding window size is adaptive to EOD width as pulsefish with longer EOD pulses typically also have lower EOD rates. With lower EOD rates, sliding window sizes should grow so that at least one EOD pulse is present in each window. To account for gaps in the recordings due to malfunctioning of the recording devices, for all timepoints where zero EOD clusters are present, surrounding fishcounts (those that are within one sliding window size of these timepoints) are also set to zero and ignored for further analysis. This is done so that only sliding windows with sufficient data are used for fish count estimates. Lastly, one window is selected where at least one EOD cluster is present, the least number of clusters are counted, and the amplitudes of the mean cluster EODs are largest. All EOD clusters that are not present in this selected window are then deleted. Sparse clusters As a final check on EOD cluster quality, EOD clusters that make up less than a certain percentage of the analyzed recording window are deleted. For this the following formula is used: Nw < T\u03c1 min . Here, N is EOD cluster size, w is EOD peak-trough width, T is the length of the analysis window and \u03c1 min is the minimum EOD density that quantifies a reliable EOD cluster. Here, \u03c1 min is set to 0.05%. Note All plots were generated by docs/pulseplots.py and are based on real data. To reproduce results, see docs/pulsedata.py .","title":"Pulse-fish EODs"},{"location":"pulses/#pulses","text":"The purpose of the algorithm is to automatically detect and classify pulse-type EODs. A recording is scanned for pulse-type EODs, which are then clustered based on their waveforms. For each pulse-type weakly electric fish present in a recording, a sufficient amount of EOD timepoints is extracted to compute a reliable estimate of their original EOD.","title":"Pulses"},{"location":"pulses/#raw-data","text":"The following figure shows some field recording snippets containing three pulse-type EODs, an artefact, and a wave-type EOD. It gives a quick overview on the variety in EOD waveforms, timescales and amplitudes. The pulses algorithm is designed to not only detect and classify pulse-type EODs, but also to discriminate between pulse and wave-type EODs, artefacts and noise.","title":"Raw data"},{"location":"pulses/#principles","text":"The pulse-fish EOD classification algorithm consists of four main steps: Data preprocessing Pulse-type EOD peak detection EOD classification (clustering) Post-processing First of all, the analyzed recording data is interpolated to 500kHz. Secondly, a peak detection algorithm is run that is specifically designed to detect multi-phasic EOD pulses in noisy environments. EOD pulses are detected even when they are superimposed on slower signals, such as wave-type EODs, 50/60Hz noise and/or static noise. Then, properties of all pulse EODs in a recording are extracted and clustered. As EOD shapes are species and location dependent, their features can be used to cluster the waveforms and infer the average waveform of each fish present in the recording. Lastly, some post-processing steps are performed to ensure that each present pulse-type electric fish is only represented once, and to ensure that the extracted EOD timepoints are sufficient to estimate a reliable average EOD waveform.","title":"Principles"},{"location":"pulses/#data-preprocessing","text":"As the clustering methods depend on EOD waveform similarities, they should be of high enough resolution to properly align and compare waveforms. To ensure this, the recording data is quadratically interpolated to 500 kHz, which should be high enough to show smooth EOD pulses even for Mormyrids.","title":"Data preprocessing"},{"location":"pulses/#pulse-type-eod-peak-detection","text":"The peak detection algorithm consists of four steps: Detect all peaks and troughs. Create peak-trough pairs. Delete peak-trough pairs with unrealistic widths ( w < 2/F s or w> 30ms ). Delete overlapping peak-trough pairs. Peaks and troughs are detected by an algorithm for identifying peaks in physiological signals (Bryan S. Todd and David C. Andrews (1999)). The threshold for this peak detection is determined by the median of the standard deviation of the recording data. The standard deviation is taken on 1000 windows of 0.5ms in size, uniformly distributed over the recording data. Choosing said window size enables the detection of pulse-type EODs peaks that are superimposed on wave-type waveforms of up to 2000Hz. Peak-trough pairs are created by connecting each peak to a neighboring trough either on the right- or on the left-hand side of the peak. To determine which trough to connect to, for both peak-trough pair options, the amplitude difference and the amplitude difference divided by the temporal difference i.e. amplitude differential are computed. If the amplitude differential is similar for both sides (<=25%), the peak-trough pair which results in the highest amplitude difference is chosen. If the amplitude differential is too variable (>25%), the peak-trough pair which results in the highest amplitude differential is chosen. Said mechanism enables correct peak detection of narrow EODs that are superimposed on low frequency waves, even when these background waves are higher in amplitude. Unrealistic peak-trough pair widths are either those that characterize noise and/or artefacts, e.g. widths that are close to the sampling frequency of the recording device, or those that are biologically not feasible due to their unrealistic temporal scale e.g. >30ms. As peak-trough pairs with said widths are likely not part of pulse-type EODs, they are discarded. Due to the nature of the peak-trough pair selection mechanism, it is possible that two peaks are connected to the same trough. As the clustering step is performed on features extracted based on both the peak and the trough of each peak-trough pair, overlap in these features is not desirable. Therefore, for all troughs that connect to two peaks, one of the peak-trough pairs is discarded. The mechanism for choosing the peak-trough pair that is to be kept is the same as the one used in step 2. Now that for each pulse-type EOD at least one peak-trough pair is made, the first features can be extracted. Extracted features are width, which is the temporal difference for each peak-trough pair, and height, which is the amplitude difference for each peak-trough pair.","title":"Pulse-type EOD peak detection"},{"location":"pulses/#eod-classification-clustering","text":"The clustering algorithm is composed of five steps. First of all, a Gaussian clustering method is used to create clusters based on EOD width. Secondly, within each width cluster, another Gaussian clustering step is performed on EOD heights. Then, within these clusters, a third clustering step is performed on the principle components of the EOD waveforms centered on the peak and on the EOD waveforms centered on the trough. For this, the DBSCAN clustering algorithm is used. The fourth step of the clustering algorithm uses the mean features of each cluster to determine which clusters are pulse EODs, and discards all wave-type EODs and artefacts. Lastly, the resulting clusters from peak-centered EOD waveforms are merged with the resulting clusters from trough-centered waveforms.","title":"EOD classification (clustering)"},{"location":"pulses/#width","text":"EOD width is the only feature that remains stable for individual fish, even when they are moving with respect to the recording electrode, and is therefore assumed to be Gaussian distributed for individual fish. A Bayesian Gaussian Mixture model (BGM) is applied to all EOD widths, where a mixture of three Gaussians is fit to the distribution. BGM models are suitable when the number of clusters is unknown, as some of the Gaussian fit weights can be set to zero. Therefore, three is merely the maximum number of clusters, where cases with less underlying EOD width distributions should result in less EOD width clusters. A maximum of three width clusters is expected, as EOD width is species dependent, and even though more than three pulsetype fish could be present in one recording, the maximum number of pulse-type fish species found in one wild recording is expected not to exceed three. To prevent faulty EOD width clustering due to sparse data, an extra check is performed, where clusters with a median width similarity of over 50% are merged.","title":"Width"},{"location":"pulses/#feature-extraction","text":"Not only is the EOD peak-trough width a useful feature for classifying EODs, it is also proportional to the entire EOD width, of which an estimate is desired to extract EOD waveforms. Therefore, after the first clustering step, EOD snippets are extracted around all EOD peaks and troughs for each width cluster, where the total snippet widths are proportional to the median peak-trough width of the EODs in that cluster (3w\u0303). In some recordings, EOD pulses are sparse and have a very good Signal to Noise Ratio ( SNR ). In this case, it is desirable to be strict in the following clustering steps, as in these conditions, it would be possible to separate EODs that are very similar in shape. If the SNR is low, e.g. due to low quality recording devices, pulsefish that are far away from the recording device, 60Hz noise, wavefish EODs and/or an abundance of electric fish in general, setting clustering thresholds that are too strict might result either in single pulsefish that are classified in multiple EOD clusters or in pulsefish that are not clustered at all. Therefore, SNR is computed for each EOD snippet, by dividing the EOD height by the background activity amplitude. The background activity amplitude is here defined as the absolute amplitude difference between the first and the last instance of each EOD snippet.","title":"Feature extraction"},{"location":"pulses/#height","text":"Now that all EOD snippets are extracted, one could cluster the EODs by their shape and height. However, automating cluster parameters at this point is tricky. As all EOD snippets contain multiple datapoints, the cluster space becomes multi-dimensional. Computing another BGM model in this space is possible and would be suitable as this method handles variable cluster densities well, due to the sigma fit that can be different for each Gaussian. To actually perform this clustering method on multi-dimensional data, on the other hand, a lot of computing time is needed as increasing dimensionality increases the search space for the model. The model could easily be stuck in local optima and would need to be run multiple times to obtain reliable results. Another drawback of using a BGM for this clustering step is that it does not account for noise and will either create a new cluster for noisy snippets or, even worse, include noise within the actual pulse EOD clusters. Consequently, regarding EOD shape, a distance-based clustering method is desired. DBSCAN is such a clustering method, which also performs well in discarding noise. For the DBSCAN method, two parameters are needed, of which one is the minimum distance between two points in cluster space for them to be identified as neighboring points. As this parameter is fixed for all clusters, all clusters should have similar densities. When taking the absolute distance between EOD snippets however, EODs with higher amplitudes will have be more distant in cluster space than EODs with lower amplitudes. This results in varying cluster densities, which complicates automating DBSCAN clustering. One could solve this issue by normalizing all EOD snippets. This again causes two problems. First of all, low amplitude EODs will show lower SNR s. If these EODs are normalized, the noise within these snippets scales linearly with the snippet. Cluster densities will now be variable not due to amplitude differences but due to SNR differences. Secondly, and most importantly, the EOD height is completely ignored when clustering, even though this contains valuable information on the pulsefish position. These issues are solved by computing two cascading clustering steps: one clustering step on height, which is a one-dimentional feature on which a BGM can be computed, and one further clustering step on EOD shape where DBSCAN is used. The relation between electrical source distance to the recording electrode and recorded EOD amplitude is negative and non-linear. In an oversimplified way, the electric field over distance is proportional to 1/r 3 , where r signifies the distance to the electric source. For stationary fish, the recorded EOD amplitude should be stable and somewhat Gaussian. Because of the non-linear relation between distance and EOD amplitude, fish that are closer to the recording electrode will have more variable EOD amplitudes than fish that are further away from the recording electrode. To account for this variance bias, clustering is done on the logarithm of the EOD amplitudes. A BGM model is used to cluster on the logarithm of the EOD heights, where a mixture of ten Gaussians is fit to the distribution. Then, all EOD height clusters with a median height similarity of 10% are merged. If 1/SNR is higher than 10%, the background noise could have influenced the EOD height distribution resulting in a higher EOD amplitude variance. To avoid splitting such clusters in half, additionally, all clusters with a median height similarity of 1/SNR are merged.","title":"Height"},{"location":"pulses/#shape","text":"There are two sets of EOD snippets, one that is EOD peak centered and one that is EOD trough centered. Depending on the relative orientation between pulsefish and electrode, EOD pulse activity could be centered either around the most significant EOD peak or trough, or around the midpoint of the most significant EOD peak and trough. Either of the snippet sets could convey most information on the EOD shape and result in the most reliable EOD clusters, thus clustering is performed on both snippets sets. The resulting clusters are merged later on. Clustering on EOD shape is done by using DBSCAN . As explained earlier, uniform cluster densities are desired and therefore, some normalization step is required. After normalizing the EOD snippets, the first five principle components are computed and used as features for clustering. This dimensionality reduction results in an improved computing time, standardizes the DBSCAN input dimensionality, and makes sure that only the most important features of the EODs are considered for clustering.","title":"Shape"},{"location":"pulses/#normalization-and-feature-extraction","text":"The first normalization step gets rid of any background activity. If the EOD is superimposed on any type of slower waveform, this background activity can be approximated by a straight line. For each EOD snippet, a linear interpolation is made between the first and the last snippet instance and subtracted from the snippet. Secondly, any DC component is deleted, by subtracting the mean of the EOD. Lastly, all EOD snippets are multiplied by a factor so that their absolute integral equals one. This last step is useful as sets of EOD snippets can have different widths. Wider EOD snippets naturally have a higher distance in cluster space due to the increase in datapoints. The absolute integral is thus secured to standardize the cluster densities and therefore clustering parameters. Lastly, PCA is done on all snippets, and the first five PCs are used for clustering.","title":"Normalization and feature extraction"},{"location":"pulses/#dbscan-parameters","text":"DBSCAN is a nearest-neighbor based clustering method that requires two parameters: epsilon and minp . minp is the minimum amount of points that is needed to form a cluster, and epsilon is a value that determines the maximum distance between two points for them to be neighbors. Both parameters are automatically set based on the data properties. minp is set to be equal to 1% of the total number of datapoints in cluster space. If this number is less than 10, minp is set to 10, as with the current thunderfish settings, the length of the analysis window is 8 seconds. As all pulse-type electric fish species generally have EOD rates above 2 Hz, a minimum cluster size of 10 is deemed sufficient. epsilon is set based on the 80 th percentile of the K-Nearest Neighbor distribution, where K is minp . This measure ensures that 80% of the datapoints in cluster space are connected to at least minp datapoints. With said method, clusters would be formed even for datapoints with great dissimilarities. To prevent epsilon from growing too large, an upper bound is set. Generally, the maximum value for epsilon ( eps_max ) would only allow for a certain variance within clusters. As all EOD snippets have their absolute integral set to 1, setting eps_max to 0.1 would result in EOD clusters with a maximum variance of 10%. However, for EODs with a low SNR , more EOD variance is expected. Therefore, if 1/SNR is over 0.25, eps_max = 0.4/SNR .","title":"DBSCAN parameters"},{"location":"pulses/#selecting-pulse-type-eod-clusters","text":"Now that all clusters are formed, all clusters that are composed of artefacts, noise, wavefish and/or wrongly centered pulse-type EODs should be deleted. To separate the desired pulse-type EOD clusters from the undesirable clusters, three measures are used. The first measure is based on the discrete Fast Fourier Transform (FFT) of the normalized average cluster waveform. Artefacts and noise are expected to have more activity in high frequency ranges, and EOD waveforms are expected to have more activity in low frequency ranges. As the FFT is limited by the Nyquist frequency ( f_Nyq ) of the recording data, and as the sampling rate is often chosen so that pulse-type EODs are slower than the Nyquist frequency, the measure that is used for determining the ratio of low frequency activity in an EOD snippet is the integral of the entire FFT divided by the integral of the mean EOD FFT up to f_Nyq/2 . All EOD clusters with low frequency ratios below 75% are discarded. The second measure is based on the ratio between EOD peak to trough widths and the distances between two consecutive EODs (ISI). Pulse-type electric fish are characterized by their relatively narrow pulses and broad ISIs while wave-type fish have pulses and ISIs that are in the same order of magnitude. Therefore, any clusters that have at least one EOD peak-trough width to ISI ratio above 0.5 are discarded. The last measure is based on the peaks and troughs found in a zoomed out version (snippet width = 8w\u0303) of the average cluster EOD, where the peaks and troughs are computed by the method of Bryan S. Todd and David C. Andrews (1999) and the threshold is set to the standard deviation of the snippet. First of all, it can be determined whether the EOD cluster is based on a wrongly centered EOD pulse, as the maximum peak-trough distance of the average cluster EOD should be centered. If this is not the case, the cluster can be deleted. Furthermore, it can be the case that an EOD cluster is composed of wavefish snippets, but was not discarded earlier, as the EODs are only sparsely detected, and therefore result in low EOD peak-trough width to ISI ratios. To account for such cases, EOD clusters are discarded if the number of peaks and troughs detected in the average zoomed out EOD exceeds four. An extra check is performed on this zoomed out average EOD by computing the difference between the width of the most significant peak-trough in the average EOD and in the original EODs. If this difference is over 50%, it indicates that even if there are some pulse-type EODs in this cluster, they are not preserved in the mean EOD and are therefore discarded.","title":"Selecting pulse-type EOD clusters"},{"location":"pulses/#merge-clusters","text":"As clustering was done on peak-centered snippets and on trough-centered EOD snippets, most pulse-type EOD clusters are represented at least twice. In some cases, the snippets that are centered either on the EOD peaks or EOD troughs are slightly misaligned, resulting in the formation of two clusters for one fish. This misalignment only happens on EOD peaks or troughs that are not in the center of the EOD pulse, as this is a more variable area than the EOD center. Due to centering the snippets on the most significant EOD peak and through, either one of the snippets should be best aligned and result in the best EOD clustering. Merging clusters is therefore done in several steps, where in each step, the largest cluster is saved. Below is some pseudo-code that describes the cluster merging algorithm. Here, A is the set of clusters for the peak-centered EODs and B is the set of clusters for the trough-centered EODs. As all detected peaks and troughs are present in pairs, each datapoint in A has one mapping to a datapoint in B . while clusters in A and B: select cluster C with largest N if C in A: delete clusters in B with at least one connection to C save cluster C and delete from A if C in B: delete clusters in A with at least one connection to C save cluster C and delete from B","title":"Merge clusters"},{"location":"pulses/#post-processing","text":"Lastly, two post-processing steps are performed to account for moving fish and sparse EOD clusters.","title":"Post-processing"},{"location":"pulses/#moving-fish","text":"Due to their dipole electric fields, electric fish that move with respect to the recording electrode display varying EOD shapes and amplitudes, which in turn leads to a single fish that is represented in multiple EOD clusters. The only factor that remains stable for moving pulsefish is their EOD pulsewidth. To ensure that each fish is only represented once, the following method is used. As EOD widths are not changing for moving fish, EODs in different width clusters are treated separately, as they cannot possibly come from the same fish. To estimate the actual number of fish in a recording for each width cluster, a sliding window is used. The sliding window is slid over all timepoints in the recording and counts the number of EOD clusters in a width cluster. The minimum number of EOD clusters that are counted within any of these windows should give a lower bound on the actual number of fish present in a recording. The stepsize of the sliding window is 0.1s. The width of this sliding window is either 0.25s, or, if the mean EOD peak-trough width is larger than 0.125ms, a factor of the mean EOD peak-trough width (2000w\u0303) of the width cluster. Sliding window size is adaptive to EOD width as pulsefish with longer EOD pulses typically also have lower EOD rates. With lower EOD rates, sliding window sizes should grow so that at least one EOD pulse is present in each window. To account for gaps in the recordings due to malfunctioning of the recording devices, for all timepoints where zero EOD clusters are present, surrounding fishcounts (those that are within one sliding window size of these timepoints) are also set to zero and ignored for further analysis. This is done so that only sliding windows with sufficient data are used for fish count estimates. Lastly, one window is selected where at least one EOD cluster is present, the least number of clusters are counted, and the amplitudes of the mean cluster EODs are largest. All EOD clusters that are not present in this selected window are then deleted.","title":"Moving fish"},{"location":"pulses/#sparse-clusters","text":"As a final check on EOD cluster quality, EOD clusters that make up less than a certain percentage of the analyzed recording window are deleted. For this the following formula is used: Nw < T\u03c1 min . Here, N is EOD cluster size, w is EOD peak-trough width, T is the length of the analysis window and \u03c1 min is the minimum EOD density that quantifies a reliable EOD cluster. Here, \u03c1 min is set to 0.05%.","title":"Sparse clusters"},{"location":"pulses/#note","text":"All plots were generated by docs/pulseplots.py and are based on real data. To reproduce results, see docs/pulsedata.py .","title":"Note"},{"location":"thunderfish/","text":"thunderfish Detect, analyze, and plot all EOD waveforms in a short recording. Authors The Neuroethology-lab at the Institute of Neuroscience at the University of T\u00fcbingen: Jan Benda J\u00f6rg Henninger (harmonic groups) Juan Sehuanes (best window) Till Raab (annotation) Liz Weerdmeester (pulse clustering) Principles of operation thunderfish automatically detects and analyzes all wave- and pulse-type EOD waveforms in a short recording. A short recording is typically no longer than about 30s. The recordings are made either with a fishfinder (a stick with two electrodes used to find electric fish in the field) or standardized head-tail recordings in a little tank. A segment for further waveform analysis is identified in the recording ( bestwindow module). In this segment the amplitude of the recording is largest while at the same time most stable and not clipped. A powerspectrum of a given frequency resolution is computed ( powerspectrum module) and potential EOD frequencies of wave-type fish are detected in this power spectrum based on their harmonic structure ( harmonics module). EODs of pulse-type fish are detected and clustered according to their width, amplitude, and shape ( pulse module). For each pulse and wave-type fish detected in the recording an averaged waveform is computed and its properties are analyzed ( eodanalysis module) The files generated by thunderfish on EOD waveform properties can be summarized in single files by means of the collectfish script and then analyzed and explored with the eodexplorer . Command line arguments thunderfish --help returns usage: thunderfish.py [-h] [--version] [-v] [-V] [-c] [--channel CHANNEL] [-t TIME] [-T] [-m {w,p,wp}] [-a] [-S] [-b] [-l [MINFREQ]] [-p] [-M PDFFILE] [-P rtpwse] [-d PATH] [-j [JOBS]] [-s] [-z] [-f {dat,ascii,csv,rtai,md,tex,html,py}] [-o OUTPATH] [-k] [-i KWARGS] [file [file ...]] Analyze EOD waveforms of weakly electric fish. positional arguments: file name of a file with time series data of an EOD recording, may include wildcards optional arguments: -h, --help show this help message and exit --version show program's version number and exit -v verbosity level. Increase by specifying -v multiple times, or like -vvv -V level for debugging plots. Increase by specifying -V multiple times, or like -VVV -c save configuration to file thunderfish.cfg after reading all configuration files --channel CHANNEL channel to be analyzed (defaults to first channel, negative channel selects all channels) -t TIME start time of analysis window in recording: \"beginning\", \"center\", \"end\", \"best\", or time in seconds (overwrites \"windowPosition\" in cofiguration file) -T add start time of analysis file to output file names -m {w,p,wp} extract wave \"w\" and/or pulse \"p\" fish EODs -a show all EOD waveforms in the summary plot -S plot spectra for all EOD waveforms in the summary plot -b indicate bad EODs in legend of power spectrum -l [MINFREQ] logarithmic frequency axis in power spectrum with optional minimum frequency (defaults to 100 Hz) -p save output plots as pdf files -M PDFFILE save all summary plots of all recordings in a multi page pdf file. Disables parallel jobs. -P rtpwse save subplots as separate pdf files: r) recording with analysis window, t) data trace with detected pulse fish, p) power spectrum with detected wave fish, w/W) mean EOD waveform, s/S) EOD spectrum, e/E) EOD waveform and spectra, d) the default summary plot. Capital letters produce a single multipage pdf containing plots of all detected fish -d PATH path to raw EOD recordings needed for plotting based on analysis results -j [JOBS] number of jobs run in parallel. Without argument use all CPU cores. -s save analysis results to files -z save analysis results in a single zip file -f {dat,ascii,csv,rtai,md,tex,html,py} file format used for saving analysis results, defaults to the format specified in the configuration file or \"csv\" -o OUTPATH path where to store results and figures (defaults to current working directory) -k keep path of input file when saving analysis files, i.e. append path of input file to OUTPATH -i KWARGS key-word arguments for the data loader function version 1.9.9 by Benda-Lab (2015-2022) examples: - analyze the single file data.wav interactively: > thunderfish data.wav - extract wavefish only: > thunderfish -m w data.wav - automatically analyze all wav files in the current working directory and save analysis results and plot to files: > thunderfish -s -p *.wav - analyze all wav files in the river1/ directory, use all CPUs, and write files directly to \"results/\": > thunderfish -j -s -p -o results/ river1/*.wav - analyze all wav files in the river1/ directory and write files to \"results/river1/\": > thunderfish -s -p -o results/ -k river1/*.wav - write configuration file: > thunderfish -c Configuration file Many parameters of the algorithms used by thunderfish can be set via a configuration file. Generate the configuration file by executing thunderfish -c This first reads in all configuration files found (see below) and then writes the file thunderfish.cfg into the current working directory. Whenever you run thunderfish it searches for configuration files in the current working directory the directory of each input file the parent directories of each input file, up to three levels up. Best practice is to move the configuration file to the root of the file tree where data files of a recording session are stored. Use the -v switch twice to see which configuration files are loaded: thunderfish -vv data.wav Open the configuration file in your favourite editor and edit the settings. Each parameter is briefly explained in the comment preceding the parameter. Important configuration parameter The list of configuration parameter is overwhelming and most of them you do not need to touch at all. Here is a list of the few that matter (in the order as they appear in the configuration file): frequencyResolution : this sets the nnft parameter for computing the power spectrum such to achieve the requested resolution in frequency. The longer your analysis window the smaller you can set the resultion (not smaller then the inverse analysis window). numberPSDWindows : If larger than one then only fish that are present in all windows are reported. If you have very stationary data (from a restrained fish, not from a fishfinder) you may set this to one. lowThresholdFactor , highThresholdFactor : play around with these numbers if not all wavefish are detected or if too many peaks are detected in the power spectrum. mainsFreq : Set it to the frequency of your mains power supply (50 or 60 Hz) or to zero if you have hum-free recordings. maxRelativePower : Usually, the higher the harmonics the less power it has. In order to discard signals whose power does not decay set this -10 or -20 dB. maxGroups : Set to 1 if you know that only a single fish is in your recording. minDataAmplitude , maxDataAmplitude : If the maximum voltage range your recording device differs from -1 to 1 (default for WAV files), set these two parameter to the limits, so that clipped recordings are detected as such. windowSize : How much of the data should be used for analysis. If you have stationary data (from a restrained fish, not from a fishfinder) you may want to use the full recording by setting this to zero. windowPosition : Where to place the analysis window: at the \"beginning\", \"center\", or \"end\" of the recording. If set to \"best\" (default) thunderfish searches for the most stationary data segment of the requested length. Can be overwritten from the command line with the -t argument. pulseWidthPercentile : If low frequency pulse fish are missed then reduce this number. eodMaxEODs : The average waveform is estimated by averaging over at maximum this number of EODs. If wavefish change their frequency then you do not want to set this number too high (10 to 100 is enough for reducing noise). If you have several fish on your recording then this number needs to be high (1000) to average away the other fish. Set it to zero in order to use all EODs in the data segment selected for analysis. flipWaveEOD , flipPulseEOD : In case of recordings with a fishfinder you do not know the orientation of the fish relative to your electrode. That is you do not know the polarity of your recording. Setting this to auto flips the sign of the averaged EOD waveform to a standardized polarity (wave-type fish: larger peak relative to average is positive, pulse-type fish: the first of the two largest peaks is positive). fileFormat : sets the default file format to be used for storing the analysis results. Summary plots By default, thunderfish simply displays the analysis results in a summary plot. You can produce these plots either from the recording files or directly from the saved analysis results ( .csv or .zip files, see next section). So to analyse some recordings and save the summary plots to pdf files in the images/ folder you call thunderfish -p -o images data/*.wav But this might take a while since the analysis is costly. Alternatively you might first analyze the recordings and save the analyis results as zip files in a results/ folder: thunderfish -j -s -z -o results data/*.wav Afterwards, you then can quickly look at the results by calling thunderfish -d data/ results/*.zip and press q to flip through the plots. The -d option tells thunderfish where it finds the corresponding files with the recordings. In the summary plots you can press q : Close the plot window and show the next one or quit. p : Play the analyzed section of the reording on the default audio device. m : Play an associated voice message file (a file with the same name but -message added. o : Switch on zoom mode. You can draw a rectangle with the mouse to zoom in. Backspace : Zoom back. f : Toggle full screen mode. Notem that the coordinates under the mouse pointer are displayed as well (usually in the bottom right corner). By default, the summary plots display at maximum four EOD waveforms with the largest amplitudes. If only a single waveform is found, then its spectrum is displayed as well. The frequencies of the power spectrum of the recording are shown on a linear scale. These behaviors can be modified by the following command line options: -a : plot all detected EOD waveforms in summary plots. -S : plot spectra for all displayed EOD waveforms. -b : indicate bad EODs in the legend of the power spectrum of the recording. -l [MINFREQ] : plot the power spectrum on a logarithmic frequency scale. The optional argument in addition allows to set the minimum frequency MINFREQ in Hertz that is displayed (defaults to 100 Hz). The plots can alternatively be saved to pdf files via the -p option. They are named RECORDING.pdf , where RECORDING is the base name of the recording file. See next section on how to define the output folder ( -o and -k options). The summary plots of all analyzed recordings can also be stored in a single, multi-page pdf file, where the results of each recording are plotted on a separate page. For this supply a name for the pdf file via the -M option. The various subplots of the summary plot can also be viewd separately or saved in separate pdf files. For this, use the -P option. It expects as an argument a string whose characters specify what you want to plot: r : plot the whole recording with the analysis window indicated (saved into RECORDING-recording.pdf ). t : plot of a small section of the data trace with detected pulse fish (saved into RECORDING-trace.pdf ). p : power spectrum of the recording with detected wave fish (saved into RECORDING-psd.pdf ). w / W : annotated mean EOD waveforms (saved into RECORDING-waveforms.pdf ). s / S : spectrum of the EOD waveform (saved into RECORDING-spectrum.pdf ). e / E : Both the annotated EOD waveform and its spectrum (saved into RECORDING-eods.pdf ). d : the default summary plot (saved into RECORDING.pdf ). Capital letters produce a single multipage pdf containing the specified plots of all detected fish of a recording. For example, thunderfish -p -P pE -d data/ -o images/ results/*.zip produces pdf files with the power spectrum of the recording and with all the EOD waveforms together with their spectra in the folder images/ . For computing the power spectrum thunderfish needs the raw data that it finds in the data/ folder. Output pathes Output files (plots and/or analysis results) are placed in the current working directory if no path is specified via the -o switch. If the path specified via -o does not exist it is created. With the -k switch the pathes of the input files are appended to the output path. This allows you to analyse recordings organized in a nested directory structure in one step and write the files in the same structure. For example: thunderfish -s -k -o analysis river1/habitatA/*.wav river1/habitatB/*.wav river2/*.wav will store the files in analysis/river1/habitatA/ analysis/river1/habitatB/ analysis/river2/ whereas without the -k switch all files are stored in analysis/ To make use of all the cores of your CPU apply the -j switch. Analysis results With the -s switch analysis results are saved to files and no interactive output plots are generated. The many output files (see below) can be combined into a single zip archive (one per recording) with the -z option. The following files are generated: RECORDING-CHANNEL-TIME-eodwaveform-N.EXT : averaged EOD waveform RECORDING-CHANNEL-TIME-waveeodfs.EXT : list of all detected EOD frequencies and powers of wave-type fish RECORDING-CHANNEL-TIME-wavefish.EXT : list of properties of good EODs of wave-type fish RECORDING-CHANNEL-TIME-wavespectrum-N.EXT : for each wave-type fish the Fourier spectrum RECORDING-CHANNEL-TIME-pulsefish.EXT : list of properties of good EODs of pulse-type fish RECORDING-CHANNEL-TIME-pulsepeaks-N.EXT : for each pulse-type fish properties of peaks and troughs RECORDING-CHANNEL-TIME-pulsetimes-N.EXT : for each pulse-type fish the time points of detected EODs RECORDING-CHANNEL-TIME-pulsespectrum-N.EXT : for each pulse-type fish the power spectrum of a single pulse Filenames are composed of the basename of the input file ( RECORDING ). In case the input files contain more than a single channel channel specification is appended ( CH ), a 'c' followed by the channel number. In case the start time of the analysis window was requested to be saved into the file name ( -T option), this start time is added to the file name ( TIME ) as an 't' followed by the start time floored to integer seconds, and an 's'. Fish detected in the recordings are numbered, starting with 0 ( N ). The file extension depends on the chosen file format ( EXT ). The following sections describe the content of the generated files. RECORDING-CHANNEL-TIME-eodwaveform-N.EXT For each fish the average waveform with standard deviation and fit. time mean std fit ms a.u. a.u. a.u. -1.746 -0.34837 0.01194 -0.34562 -1.723 -0.30700 0.01199 -0.30411 -1.701 -0.26664 0.01146 -0.26383 -1.678 -0.22713 0.01153 -0.22426 -1.655 -0.18706 0.01187 -0.18428 The columns contain: time Time in milliseconds. mean Averaged waveform in the unit of the input data. std Corresponding standard deviation. fit A fit to the averaged waveform. In case of a wave fish this is a Fourier series, for pulse fish it is an exponential fit to the tail of the last peak. RECORDING-CHANNEL-TIME-waveeodfs.EXT List of all detected EOD frequencies and powers of wave-type fish. These might be more than listed in RECORDING-CHANNEL-TIME-wavefish.EXT . index EODf datapower - Hz dB 1 111.33 -33.35 2 132.81 -37.86 0 580.08 -22.01 3 608.89 -45.45 The columns contain: index Index of the fish (the number that is also used to number the files). EODf EOD frequency in Hertz. datapower Power of this EOD in decibel (sum over all peaks in the power spectrum of the recording). RECORDING-CHANNEL-TIME-wavefish.EXT Fundamental EOD frequency and other properties of each wave-type fish detected in the recording. recording waveform timing twin window winclipped samplerate nfft dfreq index EODf p-p-amplitude power datapower thd dbdiff maxdb noise rmserror clipped flipped n ncrossings peakwidth troughwidth minwidth leftpeak rightpeak lefttrough righttrough p-p-distance min-p-p-distance relpeakampl s s % kHz - Hz - Hz a.u. dB dB % dB dB % % % - - - % % % % % % % % % % 4.25 8.00 0.00 32.000 131072 0.24 0 580.08 0.22755 -21.28 -19.05 149.81 2.93 -9.22 0.3 0.36 0.0 0 3300 1 76.15 23.85 23.85 69.12 7.03 11.10 12.75 18.13 18.13 75.73 4.25 8.00 0.00 32.000 131072 0.24 1 111.08 0.05387 -31.84 -30.09 69.07 4.12 -30.74 4.5 0.66 0.0 0 886 2 58.56 41.44 41.44 18.77 39.79 19.92 21.52 59.71 40.29 58.70 4.25 8.00 0.00 32.000 131072 0.24 2 133.06 0.02668 -37.91 -33.92 62.16 5.93 -33.64 8.4 0.45 0.0 0 1061 2 42.13 57.87 42.13 20.90 21.23 19.93 37.94 41.16 41.16 57.90 4.25 8.00 0.00 32.000 131072 0.24 3 608.64 0.01460 -44.82 -40.98 120.54 4.91 -22.21 7.2 0.41 0.0 0 4866 1 69.73 30.27 30.27 54.20 15.52 11.10 19.17 26.63 26.63 63.59 4.25 8.00 0.00 32.000 131072 0.24 4 1979.49 0.00177 -61.18 -58.72 58.05 13.10 -24.18 33.0 2.08 0.0 0 15833 2 53.94 46.06 46.06 22.94 31.00 24.67 21.38 55.67 44.33 56.82 The columns contain: twin Start time of the analysis window in the recording in seconds. window Duration of the analysis window in seconds. winclipped : Fraction of analysis window that is clipped. samplerate : Sampling rate of the recording. nfft : Number of samples used for FFT to compute power spectrum. dfreq : Frequency resolution of power spectrum. index Index of the fish (the number that is also used to number the files). EODf EOD frequency in Hertz. p-p-amplitude Peak-to-peak amplitude of the extracted waveform in the units of the input data. power Power of the extracted EOD waveform, i.e. sum of the squared Fourier amplitudes, in decibel. datapower Power of the EOD waveform from the spectrum of the original data in decibel. thd : Total harmonic distortion, i.e. square root of sum of amplitudes squared of harmonics relative to amplitude of fundamental. dbdiff Smoothness of power spectrum as standard deviation of differences in decibel power. maxdb Maximum power of higher harmonics relative to peak power in decibel. noise Root-mean-squared standard error of the averaged EOD waveform relative to the peak-to_peak amplitude in percent. rmserror Root-mean-squared difference between the averaged EOD waveform and the fit of the Fourier series relative to the peak-to_peak amplitude in percent. clipped Percentage of recording that is clipped. flipped Whether the waveform was flipped. n Number of EODs used for computing the averaged EOD waveform. ncrossings Number of zero crossing per EOD period. peakwidth Width of the peak at the averaged amplitude relative to EOD period. troughwidth Width of the trough at the averaged amplitude relative to EOD period. minwidth : peakwidth or troughwidth , whichever is smaller. leftpeak Time from positive zero crossing to peak relative to EOD period. rightpeak Time from peak to negative zero crossing relative to EOD period. lefttrough Time from negative zero crossing to trough relative to EOD period. righttrough Time from trough to positive zero crossing relative to EOD period. p-p-distance Time between peak and trough relative to EOD period. min-p-p-distance : p-p-distance or EOD period minus p-p-distance , whichever is smaller, relative to EOD period. relpeakampl Amplitude of peak or trough, whichever is larger, relative to p-p amplitude. RECORDING-CHANNEL-TIME-wavespectrum-N.EXT The parameter of the Fourier series fitted to the waveform of a wave-type fish. harmonics frequency amplitude relampl relpower phase datapower - Hz a.u. % dB rad a.u.^2/Hz 0 728.16 0.32610 100.00 0.00 0.0000 1.0137e-01 1 1456.32 0.22146 67.91 -3.36 2.4706 4.1881e-02 2 2184.48 0.03215 9.86 -20.12 -1.9333 7.6623e-04 3 2912.63 0.03733 11.45 -18.83 -0.6807 8.6311e-04 4 3640.79 0.02039 6.25 -24.08 3.0997 2.3089e-04 The columns contain: harmonics Index of the harmonics. The first one with index 0 is the fundamental frequency. frequency Frequency of the harmonics in Hertz. amplitude Amplitude of each harmonics obtained by fitting a Fourier series to the data in the unit of the input data. relampl Amplitude of each harmonics relative to the amplitude of the fundamental in percent. relpower Power of each harmonics relative to fundamental in decibel. phase Phase of each harmonics obtained by fitting a Fourier series to the data in radians ranging from 0 to 2 pi. datapower Power spectral density of the harmonics from the original power spectrum of the data. RECORDING-CHANNEL-TIME-pulsefish.EXT Properties of each pulse-type fish detected in the recording. recording waveform power spectrum twin window winclipped samplerate nfft dfreq index EODf period max-ampl min-ampl p-p-amplitude noise clipped flipped tstart tend width P2-P1-dist tau firstpeak lastpeak totalarea positivearea negativearea polaritybalance n peakfreq peakpower poweratt5 poweratt50 lowcutoff s s % kHz - Hz - Hz ms a.u. a.u. a.u. % % - ms ms ms ms ms - - a.u.*ms % % % - Hz dB dB dB Hz 4.00 8.00 0.00 32.000 131072 0.24 0 32.29 30.97 0.27713 0.21288 0.49001 0.13 0.00 0 -0.375 0.969 1.344 0.250 0.082 1 2 0.1167 57.31 -42.69 14.61 155 1130.00 -81.47 -14.08 -13.85 258.30 The columns contain: twin Start time of the analysis window in the recording in seconds. window Duration of the analysis window in seconds. winclipped : Fraction of analysis window that is clipped. samplerate : Sampling rate of the recording. nfft : Number of samples used for FFT to compute power spectrum. dfreq : Frequency resolution of power spectrum. index Index of the fish (the number that is also used to number the files). EODf EOD frequency in Hertz. period Period between two pulses (1/EODf) in milliseconds. max-ampl Amplitude of the largest peak (P1 peak) in the units of the input data. min-ampl Amplitude of the largest trough in the units of the input data. p-p-amplitude Peak-to-peak amplitude in the units of the input data. noise Root-mean-squared standard error of the averaged EOD waveform relative to the peak-to_peak amplitude in percent. clipped Percentage of recording that is clipped. flipped Whether the waveform was flipped. tstart Time where the pulse starts relative to P1 in milliseconds. tend Time where the pulse ends relative to P1 in milliseconds. width Total width of the pulse in milliseconds. P2-P1-dist : Distance between P2 and P1 in milliseconds. Zero if p2 is not present. tau Time constant of the exponential decay of the tail of the pulse in milliseconds. firstpeak Index of the first peak in the pulse (i.e. -1 for P-1). lastpeak Index of the last peak in the pulse (i.e. 3 for P3). totalarea Sum of areas under positive and negative peaks. positivearea Area under positive peaks relative to total area. negativearea Area under negative peaks relative to total area. polaritybalance Contrast between areas under positive and negative peak. n Number of EODs used for computing the averaged EOD waveform. peakfreq Frequency at the peak power of the single pulse spectrum in Hertz. peakpower Peak power of the single pulse spectrum relative to one in decibel. poweratt5 How much the average power below 5 Hz is attenuated relative to the peak power in decibel. poweratt50 How much the average power below 50 Hz is attenuated relative to the peak power in decibel. lowcutoff Frequency at which the power reached half of the peak power relative to the initial power in Hertz. RECORDING-CHANNEL-TIME-pulsepeaks-N.EXT Properties of peaks and troughs of a pulse-type fish's EOD. P time amplitude relampl width area relarea - ms a.u. % ms a.u.*ms % 1 0.000 0.27713 100.00 0.229 0.0667 57.18 2 0.250 -0.21288 -76.81 0.213 -0.0498 -42.69 The columns contain: P Name of the peak/trough. Peaks and troughs are numbered sequentially. P1 is the largest peak with positive amplitude. time Time of the peak/trough relative to P1 in milliseconds. amplitude Amplitude of the peak/trough in the unit of the input data. relampl Amplitude of the peak/trough relative to the amplitude of P1. width Width of the peak/trough at half height in milliseconds. area Area under the peak/trough. relaarea Area under the peak/trough relative to total area. RECORDING-CHANNEL-TIME-pulsetimes-N.EXT Time points of detected pulse-type EODs. time s 0.1043 0.1353 0.1662 0.1971 0.2279 0.2589 0.2898 0.3207 The columns contain: 1. The times of pulse-type EODs in seconds. RECORDING-CHANNEL-TIME-pulsespectrum-N.EXT The power spectrum of a single EOD pulse of a pulse-type fish: frequency power Hz a.u.^2/Hz 0.00 4.7637e-10 0.34 9.5284e-10 0.67 9.5314e-10 1.01 9.5363e-10 1.35 9.5432e-10 1.68 9.5522e-10 The columns contain: frequency Frequency in Hertz. power Power spectral density.","title":"thunderfish"},{"location":"thunderfish/#thunderfish","text":"Detect, analyze, and plot all EOD waveforms in a short recording.","title":"thunderfish"},{"location":"thunderfish/#authors","text":"The Neuroethology-lab at the Institute of Neuroscience at the University of T\u00fcbingen: Jan Benda J\u00f6rg Henninger (harmonic groups) Juan Sehuanes (best window) Till Raab (annotation) Liz Weerdmeester (pulse clustering)","title":"Authors"},{"location":"thunderfish/#principles-of-operation","text":"thunderfish automatically detects and analyzes all wave- and pulse-type EOD waveforms in a short recording. A short recording is typically no longer than about 30s. The recordings are made either with a fishfinder (a stick with two electrodes used to find electric fish in the field) or standardized head-tail recordings in a little tank. A segment for further waveform analysis is identified in the recording ( bestwindow module). In this segment the amplitude of the recording is largest while at the same time most stable and not clipped. A powerspectrum of a given frequency resolution is computed ( powerspectrum module) and potential EOD frequencies of wave-type fish are detected in this power spectrum based on their harmonic structure ( harmonics module). EODs of pulse-type fish are detected and clustered according to their width, amplitude, and shape ( pulse module). For each pulse and wave-type fish detected in the recording an averaged waveform is computed and its properties are analyzed ( eodanalysis module) The files generated by thunderfish on EOD waveform properties can be summarized in single files by means of the collectfish script and then analyzed and explored with the eodexplorer .","title":"Principles of operation"},{"location":"thunderfish/#command-line-arguments","text":"thunderfish --help returns usage: thunderfish.py [-h] [--version] [-v] [-V] [-c] [--channel CHANNEL] [-t TIME] [-T] [-m {w,p,wp}] [-a] [-S] [-b] [-l [MINFREQ]] [-p] [-M PDFFILE] [-P rtpwse] [-d PATH] [-j [JOBS]] [-s] [-z] [-f {dat,ascii,csv,rtai,md,tex,html,py}] [-o OUTPATH] [-k] [-i KWARGS] [file [file ...]] Analyze EOD waveforms of weakly electric fish. positional arguments: file name of a file with time series data of an EOD recording, may include wildcards optional arguments: -h, --help show this help message and exit --version show program's version number and exit -v verbosity level. Increase by specifying -v multiple times, or like -vvv -V level for debugging plots. Increase by specifying -V multiple times, or like -VVV -c save configuration to file thunderfish.cfg after reading all configuration files --channel CHANNEL channel to be analyzed (defaults to first channel, negative channel selects all channels) -t TIME start time of analysis window in recording: \"beginning\", \"center\", \"end\", \"best\", or time in seconds (overwrites \"windowPosition\" in cofiguration file) -T add start time of analysis file to output file names -m {w,p,wp} extract wave \"w\" and/or pulse \"p\" fish EODs -a show all EOD waveforms in the summary plot -S plot spectra for all EOD waveforms in the summary plot -b indicate bad EODs in legend of power spectrum -l [MINFREQ] logarithmic frequency axis in power spectrum with optional minimum frequency (defaults to 100 Hz) -p save output plots as pdf files -M PDFFILE save all summary plots of all recordings in a multi page pdf file. Disables parallel jobs. -P rtpwse save subplots as separate pdf files: r) recording with analysis window, t) data trace with detected pulse fish, p) power spectrum with detected wave fish, w/W) mean EOD waveform, s/S) EOD spectrum, e/E) EOD waveform and spectra, d) the default summary plot. Capital letters produce a single multipage pdf containing plots of all detected fish -d PATH path to raw EOD recordings needed for plotting based on analysis results -j [JOBS] number of jobs run in parallel. Without argument use all CPU cores. -s save analysis results to files -z save analysis results in a single zip file -f {dat,ascii,csv,rtai,md,tex,html,py} file format used for saving analysis results, defaults to the format specified in the configuration file or \"csv\" -o OUTPATH path where to store results and figures (defaults to current working directory) -k keep path of input file when saving analysis files, i.e. append path of input file to OUTPATH -i KWARGS key-word arguments for the data loader function version 1.9.9 by Benda-Lab (2015-2022) examples: - analyze the single file data.wav interactively: > thunderfish data.wav - extract wavefish only: > thunderfish -m w data.wav - automatically analyze all wav files in the current working directory and save analysis results and plot to files: > thunderfish -s -p *.wav - analyze all wav files in the river1/ directory, use all CPUs, and write files directly to \"results/\": > thunderfish -j -s -p -o results/ river1/*.wav - analyze all wav files in the river1/ directory and write files to \"results/river1/\": > thunderfish -s -p -o results/ -k river1/*.wav - write configuration file: > thunderfish -c","title":"Command line arguments"},{"location":"thunderfish/#configuration-file","text":"Many parameters of the algorithms used by thunderfish can be set via a configuration file. Generate the configuration file by executing thunderfish -c This first reads in all configuration files found (see below) and then writes the file thunderfish.cfg into the current working directory. Whenever you run thunderfish it searches for configuration files in the current working directory the directory of each input file the parent directories of each input file, up to three levels up. Best practice is to move the configuration file to the root of the file tree where data files of a recording session are stored. Use the -v switch twice to see which configuration files are loaded: thunderfish -vv data.wav Open the configuration file in your favourite editor and edit the settings. Each parameter is briefly explained in the comment preceding the parameter.","title":"Configuration file"},{"location":"thunderfish/#important-configuration-parameter","text":"The list of configuration parameter is overwhelming and most of them you do not need to touch at all. Here is a list of the few that matter (in the order as they appear in the configuration file): frequencyResolution : this sets the nnft parameter for computing the power spectrum such to achieve the requested resolution in frequency. The longer your analysis window the smaller you can set the resultion (not smaller then the inverse analysis window). numberPSDWindows : If larger than one then only fish that are present in all windows are reported. If you have very stationary data (from a restrained fish, not from a fishfinder) you may set this to one. lowThresholdFactor , highThresholdFactor : play around with these numbers if not all wavefish are detected or if too many peaks are detected in the power spectrum. mainsFreq : Set it to the frequency of your mains power supply (50 or 60 Hz) or to zero if you have hum-free recordings. maxRelativePower : Usually, the higher the harmonics the less power it has. In order to discard signals whose power does not decay set this -10 or -20 dB. maxGroups : Set to 1 if you know that only a single fish is in your recording. minDataAmplitude , maxDataAmplitude : If the maximum voltage range your recording device differs from -1 to 1 (default for WAV files), set these two parameter to the limits, so that clipped recordings are detected as such. windowSize : How much of the data should be used for analysis. If you have stationary data (from a restrained fish, not from a fishfinder) you may want to use the full recording by setting this to zero. windowPosition : Where to place the analysis window: at the \"beginning\", \"center\", or \"end\" of the recording. If set to \"best\" (default) thunderfish searches for the most stationary data segment of the requested length. Can be overwritten from the command line with the -t argument. pulseWidthPercentile : If low frequency pulse fish are missed then reduce this number. eodMaxEODs : The average waveform is estimated by averaging over at maximum this number of EODs. If wavefish change their frequency then you do not want to set this number too high (10 to 100 is enough for reducing noise). If you have several fish on your recording then this number needs to be high (1000) to average away the other fish. Set it to zero in order to use all EODs in the data segment selected for analysis. flipWaveEOD , flipPulseEOD : In case of recordings with a fishfinder you do not know the orientation of the fish relative to your electrode. That is you do not know the polarity of your recording. Setting this to auto flips the sign of the averaged EOD waveform to a standardized polarity (wave-type fish: larger peak relative to average is positive, pulse-type fish: the first of the two largest peaks is positive). fileFormat : sets the default file format to be used for storing the analysis results.","title":"Important configuration parameter"},{"location":"thunderfish/#summary-plots","text":"By default, thunderfish simply displays the analysis results in a summary plot. You can produce these plots either from the recording files or directly from the saved analysis results ( .csv or .zip files, see next section). So to analyse some recordings and save the summary plots to pdf files in the images/ folder you call thunderfish -p -o images data/*.wav But this might take a while since the analysis is costly. Alternatively you might first analyze the recordings and save the analyis results as zip files in a results/ folder: thunderfish -j -s -z -o results data/*.wav Afterwards, you then can quickly look at the results by calling thunderfish -d data/ results/*.zip and press q to flip through the plots. The -d option tells thunderfish where it finds the corresponding files with the recordings. In the summary plots you can press q : Close the plot window and show the next one or quit. p : Play the analyzed section of the reording on the default audio device. m : Play an associated voice message file (a file with the same name but -message added. o : Switch on zoom mode. You can draw a rectangle with the mouse to zoom in. Backspace : Zoom back. f : Toggle full screen mode. Notem that the coordinates under the mouse pointer are displayed as well (usually in the bottom right corner). By default, the summary plots display at maximum four EOD waveforms with the largest amplitudes. If only a single waveform is found, then its spectrum is displayed as well. The frequencies of the power spectrum of the recording are shown on a linear scale. These behaviors can be modified by the following command line options: -a : plot all detected EOD waveforms in summary plots. -S : plot spectra for all displayed EOD waveforms. -b : indicate bad EODs in the legend of the power spectrum of the recording. -l [MINFREQ] : plot the power spectrum on a logarithmic frequency scale. The optional argument in addition allows to set the minimum frequency MINFREQ in Hertz that is displayed (defaults to 100 Hz). The plots can alternatively be saved to pdf files via the -p option. They are named RECORDING.pdf , where RECORDING is the base name of the recording file. See next section on how to define the output folder ( -o and -k options). The summary plots of all analyzed recordings can also be stored in a single, multi-page pdf file, where the results of each recording are plotted on a separate page. For this supply a name for the pdf file via the -M option. The various subplots of the summary plot can also be viewd separately or saved in separate pdf files. For this, use the -P option. It expects as an argument a string whose characters specify what you want to plot: r : plot the whole recording with the analysis window indicated (saved into RECORDING-recording.pdf ). t : plot of a small section of the data trace with detected pulse fish (saved into RECORDING-trace.pdf ). p : power spectrum of the recording with detected wave fish (saved into RECORDING-psd.pdf ). w / W : annotated mean EOD waveforms (saved into RECORDING-waveforms.pdf ). s / S : spectrum of the EOD waveform (saved into RECORDING-spectrum.pdf ). e / E : Both the annotated EOD waveform and its spectrum (saved into RECORDING-eods.pdf ). d : the default summary plot (saved into RECORDING.pdf ). Capital letters produce a single multipage pdf containing the specified plots of all detected fish of a recording. For example, thunderfish -p -P pE -d data/ -o images/ results/*.zip produces pdf files with the power spectrum of the recording and with all the EOD waveforms together with their spectra in the folder images/ . For computing the power spectrum thunderfish needs the raw data that it finds in the data/ folder.","title":"Summary plots"},{"location":"thunderfish/#output-pathes","text":"Output files (plots and/or analysis results) are placed in the current working directory if no path is specified via the -o switch. If the path specified via -o does not exist it is created. With the -k switch the pathes of the input files are appended to the output path. This allows you to analyse recordings organized in a nested directory structure in one step and write the files in the same structure. For example: thunderfish -s -k -o analysis river1/habitatA/*.wav river1/habitatB/*.wav river2/*.wav will store the files in analysis/river1/habitatA/ analysis/river1/habitatB/ analysis/river2/ whereas without the -k switch all files are stored in analysis/ To make use of all the cores of your CPU apply the -j switch.","title":"Output pathes"},{"location":"thunderfish/#analysis-results","text":"With the -s switch analysis results are saved to files and no interactive output plots are generated. The many output files (see below) can be combined into a single zip archive (one per recording) with the -z option. The following files are generated: RECORDING-CHANNEL-TIME-eodwaveform-N.EXT : averaged EOD waveform RECORDING-CHANNEL-TIME-waveeodfs.EXT : list of all detected EOD frequencies and powers of wave-type fish RECORDING-CHANNEL-TIME-wavefish.EXT : list of properties of good EODs of wave-type fish RECORDING-CHANNEL-TIME-wavespectrum-N.EXT : for each wave-type fish the Fourier spectrum RECORDING-CHANNEL-TIME-pulsefish.EXT : list of properties of good EODs of pulse-type fish RECORDING-CHANNEL-TIME-pulsepeaks-N.EXT : for each pulse-type fish properties of peaks and troughs RECORDING-CHANNEL-TIME-pulsetimes-N.EXT : for each pulse-type fish the time points of detected EODs RECORDING-CHANNEL-TIME-pulsespectrum-N.EXT : for each pulse-type fish the power spectrum of a single pulse Filenames are composed of the basename of the input file ( RECORDING ). In case the input files contain more than a single channel channel specification is appended ( CH ), a 'c' followed by the channel number. In case the start time of the analysis window was requested to be saved into the file name ( -T option), this start time is added to the file name ( TIME ) as an 't' followed by the start time floored to integer seconds, and an 's'. Fish detected in the recordings are numbered, starting with 0 ( N ). The file extension depends on the chosen file format ( EXT ). The following sections describe the content of the generated files.","title":"Analysis results"},{"location":"thunderfish/#recording-channel-time-eodwaveform-next","text":"For each fish the average waveform with standard deviation and fit. time mean std fit ms a.u. a.u. a.u. -1.746 -0.34837 0.01194 -0.34562 -1.723 -0.30700 0.01199 -0.30411 -1.701 -0.26664 0.01146 -0.26383 -1.678 -0.22713 0.01153 -0.22426 -1.655 -0.18706 0.01187 -0.18428 The columns contain: time Time in milliseconds. mean Averaged waveform in the unit of the input data. std Corresponding standard deviation. fit A fit to the averaged waveform. In case of a wave fish this is a Fourier series, for pulse fish it is an exponential fit to the tail of the last peak.","title":"RECORDING-CHANNEL-TIME-eodwaveform-N.EXT"},{"location":"thunderfish/#recording-channel-time-waveeodfsext","text":"List of all detected EOD frequencies and powers of wave-type fish. These might be more than listed in RECORDING-CHANNEL-TIME-wavefish.EXT . index EODf datapower - Hz dB 1 111.33 -33.35 2 132.81 -37.86 0 580.08 -22.01 3 608.89 -45.45 The columns contain: index Index of the fish (the number that is also used to number the files). EODf EOD frequency in Hertz. datapower Power of this EOD in decibel (sum over all peaks in the power spectrum of the recording).","title":"RECORDING-CHANNEL-TIME-waveeodfs.EXT"},{"location":"thunderfish/#recording-channel-time-wavefishext","text":"Fundamental EOD frequency and other properties of each wave-type fish detected in the recording. recording waveform timing twin window winclipped samplerate nfft dfreq index EODf p-p-amplitude power datapower thd dbdiff maxdb noise rmserror clipped flipped n ncrossings peakwidth troughwidth minwidth leftpeak rightpeak lefttrough righttrough p-p-distance min-p-p-distance relpeakampl s s % kHz - Hz - Hz a.u. dB dB % dB dB % % % - - - % % % % % % % % % % 4.25 8.00 0.00 32.000 131072 0.24 0 580.08 0.22755 -21.28 -19.05 149.81 2.93 -9.22 0.3 0.36 0.0 0 3300 1 76.15 23.85 23.85 69.12 7.03 11.10 12.75 18.13 18.13 75.73 4.25 8.00 0.00 32.000 131072 0.24 1 111.08 0.05387 -31.84 -30.09 69.07 4.12 -30.74 4.5 0.66 0.0 0 886 2 58.56 41.44 41.44 18.77 39.79 19.92 21.52 59.71 40.29 58.70 4.25 8.00 0.00 32.000 131072 0.24 2 133.06 0.02668 -37.91 -33.92 62.16 5.93 -33.64 8.4 0.45 0.0 0 1061 2 42.13 57.87 42.13 20.90 21.23 19.93 37.94 41.16 41.16 57.90 4.25 8.00 0.00 32.000 131072 0.24 3 608.64 0.01460 -44.82 -40.98 120.54 4.91 -22.21 7.2 0.41 0.0 0 4866 1 69.73 30.27 30.27 54.20 15.52 11.10 19.17 26.63 26.63 63.59 4.25 8.00 0.00 32.000 131072 0.24 4 1979.49 0.00177 -61.18 -58.72 58.05 13.10 -24.18 33.0 2.08 0.0 0 15833 2 53.94 46.06 46.06 22.94 31.00 24.67 21.38 55.67 44.33 56.82 The columns contain: twin Start time of the analysis window in the recording in seconds. window Duration of the analysis window in seconds. winclipped : Fraction of analysis window that is clipped. samplerate : Sampling rate of the recording. nfft : Number of samples used for FFT to compute power spectrum. dfreq : Frequency resolution of power spectrum. index Index of the fish (the number that is also used to number the files). EODf EOD frequency in Hertz. p-p-amplitude Peak-to-peak amplitude of the extracted waveform in the units of the input data. power Power of the extracted EOD waveform, i.e. sum of the squared Fourier amplitudes, in decibel. datapower Power of the EOD waveform from the spectrum of the original data in decibel. thd : Total harmonic distortion, i.e. square root of sum of amplitudes squared of harmonics relative to amplitude of fundamental. dbdiff Smoothness of power spectrum as standard deviation of differences in decibel power. maxdb Maximum power of higher harmonics relative to peak power in decibel. noise Root-mean-squared standard error of the averaged EOD waveform relative to the peak-to_peak amplitude in percent. rmserror Root-mean-squared difference between the averaged EOD waveform and the fit of the Fourier series relative to the peak-to_peak amplitude in percent. clipped Percentage of recording that is clipped. flipped Whether the waveform was flipped. n Number of EODs used for computing the averaged EOD waveform. ncrossings Number of zero crossing per EOD period. peakwidth Width of the peak at the averaged amplitude relative to EOD period. troughwidth Width of the trough at the averaged amplitude relative to EOD period. minwidth : peakwidth or troughwidth , whichever is smaller. leftpeak Time from positive zero crossing to peak relative to EOD period. rightpeak Time from peak to negative zero crossing relative to EOD period. lefttrough Time from negative zero crossing to trough relative to EOD period. righttrough Time from trough to positive zero crossing relative to EOD period. p-p-distance Time between peak and trough relative to EOD period. min-p-p-distance : p-p-distance or EOD period minus p-p-distance , whichever is smaller, relative to EOD period. relpeakampl Amplitude of peak or trough, whichever is larger, relative to p-p amplitude.","title":"RECORDING-CHANNEL-TIME-wavefish.EXT"},{"location":"thunderfish/#recording-channel-time-wavespectrum-next","text":"The parameter of the Fourier series fitted to the waveform of a wave-type fish. harmonics frequency amplitude relampl relpower phase datapower - Hz a.u. % dB rad a.u.^2/Hz 0 728.16 0.32610 100.00 0.00 0.0000 1.0137e-01 1 1456.32 0.22146 67.91 -3.36 2.4706 4.1881e-02 2 2184.48 0.03215 9.86 -20.12 -1.9333 7.6623e-04 3 2912.63 0.03733 11.45 -18.83 -0.6807 8.6311e-04 4 3640.79 0.02039 6.25 -24.08 3.0997 2.3089e-04 The columns contain: harmonics Index of the harmonics. The first one with index 0 is the fundamental frequency. frequency Frequency of the harmonics in Hertz. amplitude Amplitude of each harmonics obtained by fitting a Fourier series to the data in the unit of the input data. relampl Amplitude of each harmonics relative to the amplitude of the fundamental in percent. relpower Power of each harmonics relative to fundamental in decibel. phase Phase of each harmonics obtained by fitting a Fourier series to the data in radians ranging from 0 to 2 pi. datapower Power spectral density of the harmonics from the original power spectrum of the data.","title":"RECORDING-CHANNEL-TIME-wavespectrum-N.EXT"},{"location":"thunderfish/#recording-channel-time-pulsefishext","text":"Properties of each pulse-type fish detected in the recording. recording waveform power spectrum twin window winclipped samplerate nfft dfreq index EODf period max-ampl min-ampl p-p-amplitude noise clipped flipped tstart tend width P2-P1-dist tau firstpeak lastpeak totalarea positivearea negativearea polaritybalance n peakfreq peakpower poweratt5 poweratt50 lowcutoff s s % kHz - Hz - Hz ms a.u. a.u. a.u. % % - ms ms ms ms ms - - a.u.*ms % % % - Hz dB dB dB Hz 4.00 8.00 0.00 32.000 131072 0.24 0 32.29 30.97 0.27713 0.21288 0.49001 0.13 0.00 0 -0.375 0.969 1.344 0.250 0.082 1 2 0.1167 57.31 -42.69 14.61 155 1130.00 -81.47 -14.08 -13.85 258.30 The columns contain: twin Start time of the analysis window in the recording in seconds. window Duration of the analysis window in seconds. winclipped : Fraction of analysis window that is clipped. samplerate : Sampling rate of the recording. nfft : Number of samples used for FFT to compute power spectrum. dfreq : Frequency resolution of power spectrum. index Index of the fish (the number that is also used to number the files). EODf EOD frequency in Hertz. period Period between two pulses (1/EODf) in milliseconds. max-ampl Amplitude of the largest peak (P1 peak) in the units of the input data. min-ampl Amplitude of the largest trough in the units of the input data. p-p-amplitude Peak-to-peak amplitude in the units of the input data. noise Root-mean-squared standard error of the averaged EOD waveform relative to the peak-to_peak amplitude in percent. clipped Percentage of recording that is clipped. flipped Whether the waveform was flipped. tstart Time where the pulse starts relative to P1 in milliseconds. tend Time where the pulse ends relative to P1 in milliseconds. width Total width of the pulse in milliseconds. P2-P1-dist : Distance between P2 and P1 in milliseconds. Zero if p2 is not present. tau Time constant of the exponential decay of the tail of the pulse in milliseconds. firstpeak Index of the first peak in the pulse (i.e. -1 for P-1). lastpeak Index of the last peak in the pulse (i.e. 3 for P3). totalarea Sum of areas under positive and negative peaks. positivearea Area under positive peaks relative to total area. negativearea Area under negative peaks relative to total area. polaritybalance Contrast between areas under positive and negative peak. n Number of EODs used for computing the averaged EOD waveform. peakfreq Frequency at the peak power of the single pulse spectrum in Hertz. peakpower Peak power of the single pulse spectrum relative to one in decibel. poweratt5 How much the average power below 5 Hz is attenuated relative to the peak power in decibel. poweratt50 How much the average power below 50 Hz is attenuated relative to the peak power in decibel. lowcutoff Frequency at which the power reached half of the peak power relative to the initial power in Hertz.","title":"RECORDING-CHANNEL-TIME-pulsefish.EXT"},{"location":"thunderfish/#recording-channel-time-pulsepeaks-next","text":"Properties of peaks and troughs of a pulse-type fish's EOD. P time amplitude relampl width area relarea - ms a.u. % ms a.u.*ms % 1 0.000 0.27713 100.00 0.229 0.0667 57.18 2 0.250 -0.21288 -76.81 0.213 -0.0498 -42.69 The columns contain: P Name of the peak/trough. Peaks and troughs are numbered sequentially. P1 is the largest peak with positive amplitude. time Time of the peak/trough relative to P1 in milliseconds. amplitude Amplitude of the peak/trough in the unit of the input data. relampl Amplitude of the peak/trough relative to the amplitude of P1. width Width of the peak/trough at half height in milliseconds. area Area under the peak/trough. relaarea Area under the peak/trough relative to total area.","title":"RECORDING-CHANNEL-TIME-pulsepeaks-N.EXT"},{"location":"thunderfish/#recording-channel-time-pulsetimes-next","text":"Time points of detected pulse-type EODs. time s 0.1043 0.1353 0.1662 0.1971 0.2279 0.2589 0.2898 0.3207 The columns contain: 1. The times of pulse-type EODs in seconds.","title":"RECORDING-CHANNEL-TIME-pulsetimes-N.EXT"},{"location":"thunderfish/#recording-channel-time-pulsespectrum-next","text":"The power spectrum of a single EOD pulse of a pulse-type fish: frequency power Hz a.u.^2/Hz 0.00 4.7637e-10 0.34 9.5284e-10 0.67 9.5314e-10 1.01 9.5363e-10 1.35 9.5432e-10 1.68 9.5522e-10 The columns contain: frequency Frequency in Hertz. power Power spectral density.","title":"RECORDING-CHANNEL-TIME-pulsespectrum-N.EXT"}]}